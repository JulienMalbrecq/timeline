<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timeline</title>
    <style>
        body {
            user-select: none;
        }

        #timeline {
            position: relative;
        }

        [data-timeline] {
            height: 19px;
            width: 100%;
            background: url(img/grid.png);
            position: relative;
        }

        .toggle-button {
            display: inline-block;
            border: solid 1px;
        }

        .toggle-button.active {
            background: #000;
            color: #FFF;
        }

        .time-slice {
            position: absolute;
            height: 19px;
            line-height: 19px;

            pointer-events: none;
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,.2);

            text-align: center;
            font-size: 10px;
            font-family: Arial, Helvetica, sans-serif;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <ul id="toolbar">
        <li><a href="#" data-tool="create" class="toggle-button">Create</a></li>
        <li><a href="#" data-tool="move" class="toggle-button">Move</a></li>
    </ul>

    <div id="timeline">

    </div>

    <script>
        var MainConfig = {
            services: {
                project: '',
                tasks: ''
            },
            timeline: {
                startHour: 8,
                tilesPerDay: 8,
                tileSize: 19
            }
        };
    </script>

    <script src="app.min.js"></script>
    <script>
        var wrapper = document.getElementById('timeline'),
            refDate = DateUtils.toMidnight(new Date()),
            overlapResolver = new OverlapResolver(),
            timeLine = new TimeLine(wrapper, refDate),
            renderer = new TimeLineRenderer(wrapper, refDate),
            toolBox = new TimeLineToolbox(timeLine),
            itGroup = timeLine.addGroup('it'),
            moveTool = toolBox.createTool('move'),
            createTool = toolBox.createTool('create'),
            createButtons = document.querySelectorAll('[data-tool=create]'),
            moveButtons = document.querySelectorAll('[data-tool=move]'),
            b, tmp,
            playandgold = ProjectFactory.create('Play&Gold', '#FC0'),
            antargaz = ProjectFactory.create('Antargaz', '#0F0'),
            currentProject = playandgold,
            timeSlices = [];

        itGroup.addLine('Julien');
        itGroup.addLine('Brieuc');

        createTool.mousedown = function (line, tile) {
            if (line === undefined) {
                return;
            }

            var date = timeLine.getDateFromTile(tile);
            tmp = TimeSliceFactory.create(currentProject, line.user, date, date);
            renderer.addSlice(tmp, line);
        };

        createTool.mousemove = function (line, tile) {
            var date = timeLine.getDateFromTile(tile);
            if (date >= tmp.startDate) {
                tmp.endDate = date;
            }

            renderer.refresh();
        };

        createTool.mouseup = function (line, tile) {
            var findOverlap = function (timeSlice) {
                    return timeSlice.user === tmp.user && overlapResolver.isOverlapping(timeSlice, tmp);
                },
                sameProjectFilter = function (timeSlice) {
                    return timeSlice.project === tmp.project;
                },
                overlapping = timeSlices.filter(findOverlap),
                sameProjectOverlapping = overlapping.filter(sameProjectFilter);

            if (overlapping.length > 0) {
                if (overlapping.length === sameProjectOverlapping.length) {
                    overlapping.forEach(function (refSlice) {
                        if (tmp.project === refSlice.project) {
                            overlapResolver.resolve(refSlice, tmp);
                            tmp.startDate = refSlice.startDate;
                            tmp.endDate = refSlice.endDate;
                        }
                    });

                    renderer.refresh();
                }

                renderer.removeSlice(tmp);
                tmp = null;
            } else {
                timeSlices.push(tmp);
                renderer.refresh();
            }

        };

        for (b = 0; b < createButtons.length; b += 1) {
            toolBox.attachButton(createTool, createButtons[b]);
        }

        for (b = 0; b < moveButtons.length; b += 1) {
            toolBox.attachButton(moveTool, moveButtons[b]);
        }


    </script>
</body>
</html>